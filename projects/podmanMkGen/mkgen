#!/usr/bin/env ruby
# frozen_string_literal: true

require 'liquid'
require 'toml'

test = TOML.load_file("Test.toml")
pods = test["pod"].flatten.select {|value| value.is_a?(Hash)}
conts = test["container"].flatten.select {|value| value.is_a?(Hash)}

pods.each do |pod|
  pod ["containers"] = conts.select {|container| container.has_key?("pod") && container["pod"] == pod["name"]}
end

template = Liquid::Template.parse(File.open('Makefile.liquid').read)

test_data = {
  'pods' => pods,
  'containers' => conts
}
puts template.render(test_data)
